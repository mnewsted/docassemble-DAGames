metadata:
  title: DAGames
  short title: DAGames
  comment: This program is an attempt to make a text adventure in Docassemble.
  authors:
    - Matt Newsted
---
features:
  navigation back button: False
  question back button: False
---
include:
  - rooms.yml
  - items.yml
---
modules:
  - .base
  - .rooms
  - .items
  - docassemble.ALToolbox.misc
---
objects:
  rooms: RoomList
  items: ItemList
  items_in_list: DAList.using(object_type=Thing, there_are_any=True)
---
mandatory: True
code: |
  start_screen
  while location != 999:
    results
    undefine('input_string', 'command', 'target', 'results', 'examine_item', 'item_not_visible')
  end_screen
---
sets: results
code: |
  input_string
  command = get_command(input_string)
  target = get_target(input_string)

  # exit
  if command == "exit":
    exit_screen
    
  # examine
  if command == "x" or command == "examine":
    if target == '':
      pick_item_to_examine
      debug_screen
      #pass # add code to get new target string "what do you want to examine?"
    if target in items.usable_items(location):
      examine_item
    else:
      item_not_visible
        
  # move
  if command in valid_moves:
    command = short_direction(command)
    if rooms.is_valid_exit(location, command):
      new_location = rooms[location].exits[command]
      location = new_location
    else:
      no_exit
      undefine('no_exit')
        
  results = True
  
---
code: |
  valid_moves = [ 'north', 'n', 'south', 's', 'east', 'e', 'west', 'w', 'up', 'u', 'down', 'd', 'northwest', 'nw', 'northeast', 'ne', 'southwest', 'sw', 'southeast', 'se' ]

  valid_commands = valid_moves + [ 'examine', 'x', 'exit' ]
---
id: start
continue button field: start_screen
question: |
  Start
---
id: end screen
event: end_screen
question: |
  The end
subquestion: |
  You made it to the end.
  
  Thanks for playing!
buttons:
  - Exit: exit
  - Restart: restart
---
id: exit screen
event: exit_screen
question: |
  Thanks for playing!
buttons:
  - Exit: exit
  - Restart: restart
---
id: command screen
question: |
  ${ rooms[location].name.text }
subquestion: |
  ${ rooms[location].desc }
  
  Visible exits: ${ comma_and_list( rooms.visible_exits(location) ) }

  Things you see: ${ comma_and_list( items.visible_items(location) ) }
fields:
  - What do you want to do?: input_string
    label above field: True
under: |
  ${ collapse_template(inventory_help)}
  [NEWLINE]
  ${ collapse_template(valid_commands_help)}

validation code: |
  if not (get_command(input_string) in valid_commands):
    validation_error("Command not recognized. Try again.", field='input_string')
---
template: valid_commands_help
subject: |
  **List of valid commands**
content: |
  Valid commands: ${ comma_list(valid_commands) }
---
template: inventory_help
subject: |
  **Inventory**
content: |
  % if len(items.inventory()) == 0:
    You got nothing.
  % else:
    You are carrying: ${ comma_and_list(items.inventory()) }
  % endif
---
id: invalid move
continue button field: no_exit
question: |
  You can't go ${ full_direction(command) }
subquestion: |
  ${ rooms[location].desc }
  
  Visible exits: **${ comma_and_list( rooms.visible_exits(location) ) }**
---
id: examine item
continue button field: examine_item
question: |
  Examine ${ target }
subquestion: |
  ${ items.get_description(target) }
---
id: item not visible
continue button field: item_not_visible
question: |
  Can't examine
subquestion: |
  You don't see ${ indefinite_article(target) }.
---
id: which item to examine
continue button field: pick_item_to_examine
question: |
  What do you want to examine?
subquestion: |
  This is busted.
fields:
  - no label: items_in_list
    input type: radio
    code: items.list_as_fields(location)
    #code: usable_item_list
---
id: debug
continue button field: debug_screen
question: |
  Debug
subquestion: |
  Check out those vars
---
# using .list_as_fields() instead
code: |
  usable_item_list = list()
  for item in items.usable_items(location):
    usable_item_list.append( {"label": (str(item)).capitalize(), "field": item } )
